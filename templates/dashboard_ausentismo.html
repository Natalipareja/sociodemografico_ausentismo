{% extends "nav.html" %} {% block title %}Analíticas de Ausentismo{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_graficos_ausentismo.css') }}">
    
    
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <h1 class="animate__animated animate__bounceInDown dashboard-main-title">Analíticas de Ausentismo</h1>

    <div id="loadingMessage" class="alert alert-info text-center status-message">Cargando datos del dashboard...</div>
    <div id="errorMessage" class="alert alert-danger text-center status-message" style="display: none;"></div>

    <div class="dashboard-grid">
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Edad</h3>
            <div class="chart-canvas-container">
                <canvas id="chartEdad"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Sexo</h3>
            <div class="chart-canvas-container">
                <canvas id="chartSexo"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Tipo de Contrato</h3>
            <div class="chart-canvas-container">
                <canvas id="chartTipoContrato"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Proceso</h3>
            <div class="chart-canvas-container">
                <canvas id="chartProceso"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Cargo (Top 10)</h3>
            <div class="chart-canvas-container">
                <canvas id="chartCargo"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Área (Top 10)</h3>
            <div class="chart-canvas-container">
                <canvas id="chartArea"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Turno de Trabajo</h3>
            <div class="chart-canvas-container">
                <canvas id="chartTurno"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Clase de Incapacidad</h3>
            <div class="chart-canvas-container">
                <canvas id="chartClaseIncapacidad"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por CIE-10 (Top 10)</h3>
            <div class="chart-canvas-container">
                <canvas id="chartCIE10"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Diagnóstico (Top 10)</h3>
            <div class="chart-canvas-container">
                <canvas id="chartDiagnostico"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Grupo Diagnóstico</h3>
            <div class="chart-canvas-container">
                <canvas id="chartGrupoDiagnostico"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Segmento Diagnóstico</h3>
            <div class="chart-canvas-container">
                <canvas id="chartSegmentoDiagnostico"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por Tipo de Incapacidad</h3>
            <div class="chart-canvas-container">
                <canvas id="chartTipoIncapacidad"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-card-title">Ausentismo por EPS (Top 10)</h3>
            <div class="chart-canvas-container">
                <canvas id="chartEPS"></canvas>
            </div>
        </div>
    </div> </div> 
    {% endblock %}
    
{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const dashboardGrid = document.querySelector('.dashboard-grid');
    let allCharts = {};

    // --- TUS COLORES EXISTENTES (NO SE CAMBIAN) ---
    const customChartColors = [
        '#1A3863', // Azul oscuro
        '#94DBED', // Azul claro
        '#5c94b4', // Azul medio
        '#D6D6D6'  // Gris claro
    ];
    const primaryFont = '"Poppins", sans-serif';
    const chartCardBackgroundColor = '#FFFFFF'; // Blanco, útil para texto de datalabels en fondos oscuros

    // --- REGISTRO DEL PLUGIN CHARTDATALABELS ---
    // Asegúrate de que Chart.js y el plugin estén cargados
    if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
        console.log("ChartDataLabels plugin registrado.");
    } else {
        console.error('Error: Chart.js o ChartDataLabels no están definidos. Asegúrate de que los scripts CDN estén cargados.');
        // No continuar si las librerías base no están cargadas.
        if (loadingMessage) loadingMessage.style.display = 'none';
        if (errorMessage) {
            errorMessage.textContent = 'Error crítico: No se pudieron cargar las librerías de gráficos.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    function assignChartColors(count) {
        let backgroundColors = [];
        for (let i = 0; i < count; i++) {
            backgroundColors.push(customChartColors[i % customChartColors.length]);
        }
        return { backgroundColors };
    }

    function createChart(canvasId, type, labels, data, chartCardTitleForDebug, isTopN = false, topN = 10) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error(`Error: Canvas con ID '${canvasId}' no encontrado.`);
            if (errorMessage) {
                errorMessage.textContent = `Error: No se encontró el canvas para el gráfico: ${chartCardTitleForDebug || canvasId}.`;
                errorMessage.style.display = 'block';
            }
            if (loadingMessage) loadingMessage.style.display = 'none';
            return;
        }

        const { backgroundColors } = assignChartColors(labels.length);

        if (allCharts[canvasId]) {
            allCharts[canvasId].destroy();
        }

        // --- CONFIGURACIÓN DE DATALABELS ---
        const datalabelsConfig = {
            display: true,
            font: {
                family: primaryFont,
                weight: 'bold',
                size: 10 // Tamaño base, puedes ajustarlo
            },
            formatter: function(value, context) {
                if (value === null || typeof value === 'undefined') return '';
                // Para pie/doughnut, es común mostrar porcentajes o no mostrar si el valor es 0
                if (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut') {
                    if (value === 0) return ''; // No mostrar etiqueta para valor 0 en pie/dona
                    const chartData = context.chart.data.datasets[0].data;
                    const total = chartData.reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                    if (total === 0) return '0%';
                    const percentage = (value / total * 100).toFixed(1) + '%';
                    return percentage; // Muestra porcentaje para pie/dona
                }
                return value; // Muestra el valor para otros tipos de gráfico
            },
            color: function(context) {
                // Lógica para contraste de color de la etiqueta
                const chartType = context.chart.config.type;
                const currentBgColor = context.dataset.backgroundColor[context.dataIndex] || context.dataset.backgroundColor;

                if (chartType === 'pie' || chartType === 'doughnut') {
                    // Colores claros de tu paleta que necesitan texto oscuro
                    if (currentBgColor === '#94DBED' || currentBgColor === '#D6D6D6') {
                        return '#1A3863'; // Azul oscuro (texto oscuro)
                    }
                    return chartCardBackgroundColor; // Blanco (texto claro) para los demás
                }
                // Para barras, si el color de la barra es muy oscuro, usar blanco.
                // Asumimos que las barras usan un solo color o el primer color de customChartColors.
                // Esta lógica podría necesitar ajuste si el color de la barra es dinámico y claro.
                if (currentBgColor === '#1A3863' || currentBgColor === '#5c94b4'){
                     return chartCardBackgroundColor; // Texto blanco
                }
                return 'red'; // Texto oscuro para barras claras
            },
            anchor: function(context) {
                const chartType = context.chart.config.type;
                return (chartType === 'pie' || chartType === 'doughnut') ? 'center' : 'end';
            },
            align: function(context) {
                const chartType = context.chart.config.type;
                if (chartType === 'pie' || chartType === 'doughnut') {
                    return 'center';
                }
                const indexAxis = context.chart.options.indexAxis || 'x'; // Default a 'x' si no está definido
                return indexAxis === 'y' ? 'start' : 'top'; // 'start' para horizontal, 'top' para vertical
            },
            offset: function(context) {
                const chartType = context.chart.config.type;
                if (chartType === 'bar' || chartType === 'line') {
                     const indexAxis = context.chart.options.indexAxis || 'x';
                     return indexAxis === 'y' ? 8 : 4; // Más offset para barras horizontales
                }
                return 0;
            },
            padding: 0
        };
        // --- FIN CONFIGURACIÓN DE DATALABELS ---


        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { // Plugins existentes y el nuevo datalabels
                legend: {
                    display: (type === 'pie' || type === 'doughnut') && labels.length > 1,
                    position: 'right',
                    align: 'center',
                    labels: {
                        color: '#495057',
                        font: { family: primaryFont, size: 10 },
                        boxWidth: 10,
                        boxHeight: 10,
                        padding: 10,
                        usePointStyle: false
                    }
                },
                title: { display: false },
                tooltip: { /* ... tu configuración de tooltip existente ... */ },
                datalabels: datalabelsConfig // <--- SE AÑADE LA CONFIGURACIÓN DEL PLUGIN AQUÍ
            },
            layout: { /* ... tu configuración de layout existente ... */ }
        };

        if (type === 'bar' || type === 'line') {
            // Tu lógica existente para escalas
            chartOptions.scales = { /* ... tu configuración de escalas ... */ };
            if (chartOptions.plugins.legend) { /* ... tu lógica de leyenda para barras ... */ }
        }

        try {
            allCharts[canvasId] = new Chart(ctx.getContext('2d'), { // Asegurar pasar el contexto 2d
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: chartCardBackgroundColor,
                        borderWidth: (type === 'pie' || type === 'doughnut') ? 2 : 1.5,
                        hoverBorderColor: chartCardBackgroundColor,
                        hoverBorderWidth: (type === 'pie' || type === 'doughnut') ? 2 : 1.5,
                    }]
                },
                options: chartOptions
            });
        } catch (e) {
            console.error(`Error al crear el gráfico '${canvasId}':`, e);
            const cardWithError = ctx.closest('.chart-card');
            if(cardWithError) {
                cardWithError.innerHTML = `<h3 class="chart-card-title">${chartCardTitleForDebug || canvasId}</h3><p class="text-danger text-center small p-3">Error al cargar este gráfico.</p>`;
            }
        }
    }

    // --- TU LÓGICA DE PROCESAMIENTO DE DATOS (countOccurrences, processAgeData, getTopN) ---
    // (Se mantiene igual que en tu script original)
    function countOccurrences(dataArray, key) { 
        const counts = {};
        if (!Array.isArray(dataArray)) return counts;
        dataArray.forEach(item => {
            const value = (item && item[key] !== null && item[key] !== undefined) ? item[key] : 'No especificado'; 
            counts[value] = (counts[value] || 0) + 1;
        });
        return counts;
    }
    function processAgeData(dataArray) { 
        const ageRanges = {
            'Menor a 20': 0, '20-29': 0, '30-39': 0, '40-49': 0, '50-59': 0, '60 o más': 0, 'No especificado': 0
        };
        if (!Array.isArray(dataArray)) return ageRanges;
        dataArray.forEach(item => {
            const age = (item && item.edad_empleado !== null && item.edad_empleado !== undefined) ? parseInt(item.edad_empleado, 10) : null;
            if (age === null || isNaN(age)) { // Chequeo adicional por NaN
                ageRanges['No especificado']++;
            } else if (age < 20) ageRanges['Menor a 20']++;
            else if (age >= 20 && age <= 29) ageRanges['20-29']++;
            else if (age >= 30 && age <= 39) ageRanges['30-39']++;
            else if (age >= 40 && age <= 49) ageRanges['40-49']++;
            else if (age >= 50 && age <= 59) ageRanges['50-59']++;
            else if (age >=60) ageRanges['60 o más']++;
            else ageRanges['No especificado']++; 
        });
        return ageRanges;
    }
    function getTopN(counts, n = 10) { 
        if (typeof counts !== 'object' || counts === null) return {};
        const sorted = Object.entries(counts)
            .sort(([,a],[,b]) => b-a)
            .slice(0, n);
        return Object.fromEntries(sorted);
    }

    // --- TU LÓGICA DE FETCH Y CREACIÓN DE GRÁFICOS ---
    // (Se mantiene igual que en tu script original)
    console.log("Iniciando fetch para datos del dashboard...");
    fetch("{{ url_for('ausentismo.dashboard_ausentismo_data') }}")
        .then(response => {
            console.log("Respuesta recibida del servidor, estado:", response.status);
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.error || `Error HTTP: ${response.status} ${response.statusText}`);
                }).catch(() => {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Datos recibidos y parseados:", data);
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (dashboardGrid) dashboardGrid.style.display = 'grid';

            if (!data || (Array.isArray(data) && data.length === 0)) {
                if (errorMessage) {
                    errorMessage.textContent = 'No hay datos de ausentismo disponibles para mostrar en el dashboard.';
                    errorMessage.style.display = 'block';
                }
                console.warn("No hay datos para mostrar.");
                return;
            }
            if (typeof data !== 'object' && !Array.isArray(data)) {
                 if (errorMessage) {
                    errorMessage.textContent = 'Los datos recibidos no tienen el formato esperado.';
                    errorMessage.style.display = 'block';
                }
                console.error("Formato de datos incorrecto:", data);
                return;
            }
            
            try {
                createChart('chartEdad', 'bar', Object.keys(processAgeData(data)), Object.values(processAgeData(data)), "Ausentismo por Edad");
                createChart('chartSexo', 'pie', Object.keys(countOccurrences(data, 'sexo_empleado')), Object.values(countOccurrences(data, 'sexo_empleado')), "Ausentismo por Sexo");
                createChart('chartTipoContrato', 'bar', Object.keys(countOccurrences(data, 'nombre_tipo_contrato')), Object.values(countOccurrences(data, 'nombre_tipo_contrato')), "Ausentismo por Tipo de Contrato");
                createChart('chartProceso', 'doughnut', Object.keys(countOccurrences(data, 'nombre_proceso')), Object.values(countOccurrences(data, 'nombre_proceso')), "Ausentismo por Proceso");
                
                const cargoData = countOccurrences(data, 'nombre_cargo');
                createChart('chartCargo', 'bar', Object.keys(getTopN(cargoData)), Object.values(getTopN(cargoData)), "Ausentismo por Cargo", Object.keys(cargoData).length > 10, 10);
                
                const areaData = countOccurrences(data, 'nombre_area');
                createChart('chartArea', 'pie', Object.keys(getTopN(areaData)), Object.values(getTopN(areaData)), "Ausentismo por Área", Object.keys(areaData).length > 10, 10);

                createChart('chartTurno', 'bar', Object.keys(countOccurrences(data, 'nombre_turno_trabajo')), Object.values(countOccurrences(data, 'nombre_turno_trabajo')), "Ausentismo por Turno de Trabajo");
                createChart('chartClaseIncapacidad', 'doughnut', Object.keys(countOccurrences(data, 'nombre_clase_incapacidad')), Object.values(countOccurrences(data, 'nombre_clase_incapacidad')), "Ausentismo por Clase de Incapacidad");
                
                const cie10Data = countOccurrences(data, 'codigo_diagnostico_cie10');
                createChart('chartCIE10', 'bar', Object.keys(getTopN(cie10Data)), Object.values(getTopN(cie10Data)), "Ausentismo por CIE-10", true, 10);
                
                const diagnosticoData = countOccurrences(data, 'nombre_diagnostico');
                createChart('chartDiagnostico', 'pie', Object.keys(getTopN(diagnosticoData)), Object.values(getTopN(diagnosticoData)), "Ausentismo por Diagnóstico", true, 10);

                createChart('chartGrupoDiagnostico', 'bar', Object.keys(countOccurrences(data, 'grupo_diagnostico')), Object.values(countOccurrences(data, 'grupo_diagnostico')), "Ausentismo por Grupo Diagnóstico");
                createChart('chartSegmentoDiagnostico', 'doughnut', Object.keys(countOccurrences(data, 'segmento_diagnostico')), Object.values(countOccurrences(data, 'segmento_diagnostico')), "Ausentismo por Segmento Diagnóstico");
                createChart('chartTipoIncapacidad', 'pie', Object.keys(countOccurrences(data, 'nombre_tipo_incapacidad')), Object.values(countOccurrences(data, 'nombre_tipo_incapacidad')), "Ausentismo por Tipo de Incapacidad");
                
                const epsData = countOccurrences(data, 'nombre_eps');
                createChart('chartEPS', 'bar', Object.keys(getTopN(epsData)), Object.values(getTopN(epsData)), "Ausentismo por EPS", Object.keys(epsData).length > 10, 10);
            } catch (e) {
                console.error("Error durante la creación de gráficos:", e);
                if (errorMessage) {
                    errorMessage.textContent = 'Ocurrió un error al generar los gráficos.';
                    errorMessage.style.display = 'block';
                }
            }

        })
        .catch(error => {
            console.error("Error en fetch o al procesar los datos:", error);
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (dashboardGrid) dashboardGrid.style.display = 'grid'; 
            if (errorMessage) {
                errorMessage.textContent = `Error al cargar datos del dashboard: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        });
});
</script>
{% endblock %}
